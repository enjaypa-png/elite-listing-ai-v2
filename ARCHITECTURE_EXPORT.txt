# ELITE LISTING AI - ARCHITECTURE EXPORT
# Repository: enjaypa-png/elite-listing-ai-v2
# Branch: unified-mvp
# Export Date: November 7, 2025
# Purpose: Architecture Review & Documentation

========================================
QUICK SUMMARY
========================================

Total API Endpoints: 12+
- /api/optimize (Listing optimizer with 285-point system)
- /api/optimize/image/analyze (Single photo analysis)
- /api/optimize/images/batch-analyze (Batch 10 photos - NEW)
- /api/keywords/generate (Keyword research)
- /api/seo/audit (SEO audit with 285-point system)
- /api/etsy/connect (OAuth connection)
- /api/etsy/import (Import listings from Etsy)
- /api/etsy/sync (Sync changes to Etsy)
- /api/user/profile
- /api/user/credits
- /api/checkout (Stripe payments)
- /api/optimizations (History)

Database Tables: 8
1. User (auth, profile)
2. Shop (Etsy shop connections)
3. Listing (imported Etsy listings)
4. Optimization (optimization jobs)
5. OptimizationVariant (generated variants)
6. PhotoScore (image analysis results)
7. CreditLedger (credit transactions)
8. WebhookEvent (webhook processing)

Etsy Integration Status:
âœ… OAuth Connection - Working
âœ… Import Listings - Working (extracts all 10 photos)
âœ… Sync to Etsy - Working (updates title, description, tags)
âš ï¸ Real-time sync - Requires testing with live Etsy account

Tech Stack:
- Next.js 15.5.6 (App Router)
- TypeScript 5.9.3
- PostgreSQL (Supabase) + Prisma ORM
- OpenAI GPT-4o + Vision API
- Stripe 19.1.0
- NextAuth v5

========================================
PRIORITY 1 FILES
========================================

=== FILENAME: /app/api/optimize/route.ts ===
[Listing Optimizer with 285-Point System - UPGRADED]
import { NextRequest, NextResponse } from 'next/server';
import { z } from 'zod';
import { randomUUID } from 'crypto';
import { prisma } from '@/lib/prisma';
import { getOpenAIClient } from '@/lib/openai';
import { getCurrentUser } from '@/lib/auth-helpers';

export const runtime = 'nodejs'

// HEAD method for health check probe
export async function HEAD(request: NextRequest) {
  return new NextResponse(null, { status: 200 })
}

// Input validation schema
const OptimizeRequestSchema = z.object({
  platform: z.string().min(1, 'Platform is required').default('etsy'),
  title: z.string().min(1, 'Title is required'),
  description: z.string().optional(),
  tags: z.array(z.string()).optional(),
  photoScore: z.number().min(0).max(100).optional().default(75),
  tone: z.enum(['persuasive', 'minimalist', 'luxury', 'seo-heavy']).optional().default('persuasive'),
  listingId: z.string().optional(), // Optional Etsy listing ID for prefill
});

interface OptimizationVariant {
  title: string;
  description: string;
  tags: string[];
  copyScore: number;
  clarity: number;
  persuasion: number;
  seoDensity: number;
  keywordHarmony: number;
  readabilityScore: number;
  emotionScore: number;
  ctrProbability: number;
  conversionProbability: number;
}

// Helper function to calculate Flesch Reading Ease score
function calculateFleschScore(text: string): number {
  const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0).length;
  const words = text.split(/\s+/).filter(w => w.length > 0).length;
  const syllables = text.split(/\s+/).reduce((count, word) => {
    return count + countSyllables(word);
  }, 0);
  
  if (sentences === 0 || words === 0) return 0;
  
  const score = 206.835 - 1.015 * (words / sentences) - 84.6 * (syllables / words);
  return Math.max(0, Math.min(100, Math.round(score)));
}

function countSyllables(word: string): number {
  word = word.toLowerCase().replace(/[^a-z]/g, '');
  if (word.length <= 3) return 1;
  
  const vowels = word.match(/[aeiouy]+/g);
  let count = vowels ? vowels.length : 1;
  
  if (word.endsWith('e')) count--;
  if (word.endsWith('le') && word.length > 2) count++;
  
  return Math.max(1, count);
}

// Helper function to calculate keyword density
function calculateKeywordDensity(text: string, keyword: string): number {
  const words = text.toLowerCase().split(/\s+/);
  const keywordWords = keyword.toLowerCase().split(/\s+/);
  let matches = 0;
  
  for (let i = 0; i <= words.length - keywordWords.length; i++) {
    const phrase = words.slice(i, i + keywordWords.length).join(' ');
    if (phrase === keywordWords.join(' ')) matches++;
  }
  
  return words.length > 0 ? (matches / words.length) * 100 : 0;
}

// Helper function to detect emotion triggers
function detectEmotionTriggers(text: string): string[] {
  const emotionWords = [
    'love', 'beautiful', 'perfect', 'amazing', 'stunning', 'gorgeous',
    'unique', 'special', 'handmade', 'artisan', 'crafted', 'premium',
    'luxury', 'elegant', 'timeless', 'exclusive', 'limited', 'rare',
    'cozy', 'comfortable', 'soft', 'warm', 'delightful', 'charming'
  ];
  
  const textLower = text.toLowerCase();
  return emotionWords.filter(word => textLower.includes(word));
}

// Helper function to analyze listing quality
function analyzeListingQuality(title: string, description: string, tags: string[], platform: string) {
  const complianceIssues: string[] = [];
  const suggestions: string[] = [];
  
  // Extract primary keyword
  const titleWords = title.split(/\s+/);
  const primaryKeyword = titleWords.slice(0, 3).join(' ');
  
  // Calculate keyword density
  const keywordDensity = calculateKeywordDensity(description, primaryKeyword);
  
  // Find primary keyword position
  const primaryKeywordPosition = title.toLowerCase().indexOf(primaryKeyword.toLowerCase());
  
  // Title length check
  const titleLength = title.length;
  if (platform === 'etsy' && titleLength > 140) {
    complianceIssues.push('Title exceeds Etsy\\'s 140 character limit');
  }
  
  // Keyword density check
  if (keywordDensity < 1.5) {
    suggestions.push('Increase keyword density to 1.5-3% for better SEO');
  } else if (keywordDensity > 3.0) {
    complianceIssues.push('Keyword density too high - risk of keyword stuffing penalty');
  }
  
  // Tag count check
  if (platform === 'etsy' && tags.length !== 13) {
    complianceIssues.push(`Etsy requires exactly 13 tags (currently ${tags.length})`);
  }
  
  // Flesch score
  const fleschScore = calculateFleschScore(description);
  if (fleschScore < 60) {
    suggestions.push('Improve readability - text is too complex');
  }
  
  // Emotion triggers
  const emotionTriggers = detectEmotionTriggers(title + ' ' + description);
  if (emotionTriggers.length < 3) {
    suggestions.push('Add more emotional trigger words to increase appeal');
  }
  
  return {
    keywordDensity,
    primaryKeywordPosition,
    titleLength,
    fleschScore,
    emotionTriggers,
    complianceIssues,
    suggestions,
  };
}

// Helper function to calculate advanced scores
function calculateAdvancedScores(variant: any, analysis: any, platform: string): Partial<OptimizationVariant> {
  const clarity = Math.min(100, Math.round(analysis.fleschScore * 1.2));
  
  const emotionScore = Math.min(100, analysis.emotionTriggers.length * 10);
  const descriptionLength = variant.description.length;
  const lengthScore = descriptionLength >= 150 && descriptionLength <= 300 ? 100 : 70;
  const persuasion = Math.round((emotionScore * 0.6 + lengthScore * 0.4));
  
  let seoDensity = 0;
  if (analysis.keywordDensity >= 1.5 && analysis.keywordDensity <= 3.0) {
    seoDensity = 100;
  } else if (analysis.keywordDensity < 1.5) {
    seoDensity = Math.round((analysis.keywordDensity / 1.5) * 100);
  } else {
    seoDensity = Math.max(0, 100 - (analysis.keywordDensity - 3.0) * 20);
  }
  
  const positionScore = analysis.primaryKeywordPosition <= 60 ? 100 : 60;
  const tagScore = variant.tags.length === 13 ? 100 : 70;
  const keywordHarmony = Math.round((positionScore * 0.6 + tagScore * 0.4));
  
  const titleScore = analysis.titleLength <= 140 ? 100 : 70;
  const emotionalAppeal = Math.min(100, analysis.emotionTriggers.length * 15);
  const ctrProbability = Math.round((titleScore * 0.4 + emotionalAppeal * 0.3 + keywordHarmony * 0.3));
  
  const conversionProbability = Math.round((clarity * 0.3 + persuasion * 0.4 + seoDensity * 0.3));
  
  return {
    clarity,
    persuasion,
    seoDensity,
    keywordHarmony,
    readabilityScore: analysis.fleschScore,
    emotionScore,
    ctrProbability,
    conversionProbability,
  };
}

// GET /api/optimize - Health check endpoint
export async function GET() {
  return NextResponse.json({
    ok: true,
    status: 'optimize endpoint ready (v2.0 - 285-point system)',
    model: 'gpt-4o',
    hasApiKey: !!process.env.OPENAI_API_KEY,
    features: [
      'Authentication Required',
      'Credit System Integration',
      'Database Persistence',
      'GPT-4o with 285-Point Scoring',
      'Etsy 2025 Algorithm',
    ],
  });
}

// POST /api/optimize - Optimize listing content with 285-point system
export async function POST(request: NextRequest) {
  const requestId = randomUUID();
  
  try {
    console.log(`[${requestId}] Starting optimization request (285-point system)...`);
    
    // 1. Authentication check
    const user = await getCurrentUser(request);
    if (!user) {
      return NextResponse.json(
        { ok: false, error: { code: 'unauthorized', message: 'Authentication required', requestId } },
        { status: 401 }
      );
    }
    
    console.log(`[${requestId}] User authenticated: ${user.id}`);
    
    // 2. Parse and validate input
    const body = await request.json();
    const validatedInput = OptimizeRequestSchema.parse(body);
    const { platform, title, description, tags, photoScore, tone, listingId } = validatedInput;
    
    console.log(`[${requestId}] Input validated: platform=${platform}, tone=${tone}`);
    
    // 3. Check user credit balance
    const lastLedgerEntry = await prisma.creditLedger.findFirst({
      where: { userId: user.id },
      orderBy: { createdAt: 'desc' },
    });
    
    const currentBalance = lastLedgerEntry?.balance || 0;
    
    if (currentBalance < 1) {
      console.log(`[${requestId}] Insufficient credits: balance=${currentBalance}`);
      return NextResponse.json(
        {
          ok: false,
          error: {
            code: 'insufficient_credits',
            message: 'Insufficient credits. Please purchase more credits to continue.',
            currentBalance,
            requestId,
          },
        },
        { status: 402 }
      );
    }
    
    console.log(`[${requestId}] Credit check passed: balance=${currentBalance}`);
    
    // 4. Check OpenAI configuration
    if (!process.env.OPENAI_API_KEY) {
      console.error(`[${requestId}] OpenAI API key not configured`);
      return NextResponse.json(
        { ok: false, error: { code: 'missing_api_key', message: 'OpenAI API key not configured', requestId } },
        { status: 500 }
      );
    }
    
    // 5. Create optimization record (status: processing)
    const optimization = await prisma.optimization.create({
      data: {
        userId: user.id,
        listingId: listingId || null,
        type: 'full',
        status: 'processing',
        creditsUsed: 0, // Will be set to 1 on success
        aiModel: 'gpt-4o-285point',
        originalContent: {
          title,
          description: description || '',
          tags: tags || [],
          platform,
          tone,
          photoScore,
        },
      },
    });
    
    console.log(`[${requestId}] Optimization record created: ${optimization.id}`);
    
    // 6. Build Enhanced AI Prompt with 285-Point System
    const toneInstructions = {
      persuasive: 'Use emotional triggers, storytelling, and benefit-focused language.',
      minimalist: 'Use clean, concise language. Focus on essential features.',
      luxury: 'Use sophisticated, premium language. Emphasize exclusivity and craftsmanship.',
      'seo-heavy': 'Maximize keyword usage while maintaining readability.',
    };
    
    const systemPrompt = `You are the AI optimization engine for Elite Listing AI, powered by Etsy's complete 2025 algorithm intelligence and 285-point scoring system.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸŽ¯ ETSY'S 2025 ALGORITHM - 8 RANKING FACTORS (PRIORITY ORDER)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
1. Listing Quality Score (30% weight) - CTR, conversion, favorites, sales velocity, image quality
2. Conversion Rate (25% weight) - Orders Ã· Visits Ã— 100 (target: 3%+ competitive, 4%+ excellent)
3. Customer & Market Experience (15% weight) - Reviews, <24hr response, on-time shipping
4. Recency (10% weight) - New listings get temporary boost
5. Shipping Price (8% weight) - US domestic under $6 gets ranking boost
6. Click-Through Rate (7% weight) - Target: ~2% (2 clicks per 100 impressions)
7. Shop Performance (3% weight) - Overall shop health
8. Personalization (2% weight) - AI matches to buyer behavior

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ“Š 285-POINT SCORING SYSTEM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ðŸ† TITLE OPTIMIZATION (50 points max):
âœ… Primary keyword in first 5 words: 15 pts
âœ… Buyer intent phrases (e.g., "gift for mom", "personalized wedding"): 10 pts
âœ… Readability maintained (not keyword-stuffed): 10 pts
âœ… Character count 60-140: 5 pts
âœ… Multi-word keyword phrases vs single words: 5 pts
âœ… Unique from seller's other listings: 5 pts

CRITICAL TITLE RULES:
â€¢ Front-load primary keyword while staying readable
â€¢ Use buyer intent language, not just product descriptors
â€¢ NO keyword stuffing (algorithm penalizes in 2025)

EXAMPLE:
âŒ BAD: "Print Art Wall Decor Poster Modern Minimalist Design"
âœ… GOOD: "Modern Minimalist Wall Art Print | Scandinavian Bedroom Decor | Instant Download"

---

ðŸ·ï¸ TAGS OPTIMIZATION (35 points max):
âœ… 13 tags used (maximum): 10 pts
âœ… Tags reinforce title keywords: 8 pts
âœ… Long-tail variations included: 7 pts
âœ… No duplicate category/attribute terms: 5 pts
âœ… Mix of broad + specific terms: 5 pts

TAG STRATEGY (13 tags total):
1. Primary keyword variations (3-4 tags)
2. Buyer intent phrases (2-3 tags: "gift for mom", "baby shower present")
3. Style/aesthetic descriptors (2-3 tags: "modern minimalist", "boho chic")
4. Occasion/gift tags (2-3 tags: "wedding decor", "birthday gift")
5. Material/feature tags (2-3 tags: "instant download", "printable art")

CRITICAL TAG RULES:
â€¢ DON'T repeat category/attribute words - they auto-populate as tags
â€¢ Use long-tail (e.g., "boho nursery wall art" not just "wall art")
â€¢ Vary across listings - identical terms dilute effectiveness

---

ðŸ“ DESCRIPTION OPTIMIZATION (30 points max):
âœ… First 160 characters compelling + keyword-rich: 10 pts (search snippet!)
âœ… Benefits highlighted over features: 6 pts
âœ… Answers common buyer questions: 6 pts
âœ… Natural keyword integration (not stuffed): 5 pts
âœ… Clear size/dimension info: 3 pts

STRUCTURE (Required):
1. HOOK (First 160 chars): Primary keyword + benefit + desire
2. BENEFITS: What problem solved, how it improves life
3. SPECIFICATIONS: Dimensions, materials, what's included
4. USAGE/CARE: How to use/display
5. SHIPPING: Processing time, return policy

LENGTH: 1000-2000 characters optimal
TONE: ${toneInstructions[tone]}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âŒ CRITICAL DON'TS (Instant Penalties):
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â€¢ DON'T keyword stuff - algorithm actively penalizes
â€¢ DON'T use identical keywords across listings
â€¢ DON'T repeat category words in tags
â€¢ DON'T ignore mobile (44%+ traffic from app)
â€¢ DON'T rely on old tactics - 2025 is behavior-driven

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸŽ¯ YOUR TASK:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Generate 3 optimized variants following the 285-point system.

For EACH variant provide:
1. Title (60-140 chars, keyword in first 5 words)
2. Description (1000-2000 chars, compelling first 160)
3. 13 tags (multi-word, no duplicates)
4. 285-point breakdown (title/tags/description scores)
5. Reasoning (WHY changes improve rankings)
6. Expected improvements (ranking/CTR/conversion %)

Be SPECIFIC, explain algorithm reasoning, show expected ROI.

OUTPUT JSON:
{
  "variants": [
    {
      "variantNumber": 1,
      "title": "Primary Keyword First | Buyer Intent | Additional",
      "description": "Hook in first 160... Benefits... Specs... Care... Shipping...",
      "tags": ["long tail tag 1", "buyer intent tag 2", ... 13 total],
      "scores": {
        "title": {"score": 45, "maxScore": 50, "breakdown": {...}, "issues": [], "strengths": []},
        "tags": {"score": 32, "maxScore": 35, "breakdown": {...}, "issues": [], "strengths": []},
        "description": {"score": 28, "maxScore": 30, "breakdown": {...}, "issues": [], "strengths": []},
        "totalScore": 105,
        "percentage": 91,
        "rating": "Excellent"
      },
      "reasoning": "Specific algorithm explanation why this works",
      "expectedImprovements": {"ranking": "+40%", "ctr": "+25%", "conversion": "+18%"}
    }
  ],
  "analysis": {
    "primaryKeyword": "modern minimalist wall art",
    "buyerIntent": "home decor + gifting",
    "criticalIssues": [{"severity": "critical", "issue": "...", "fix": "...", "impact": "..."}],
    "quickWins": [{"change": "...", "effort": "Easy", "impact": "+15 pts"}]
  }
}`;
    
    const userPrompt = `Original Listing:
Platform: ${platform}
Title: ${title}
Description: ${description || 'Not provided'}
Current Tags: ${tags?.join(', ') || 'None'}
Photo Quality Score: ${photoScore}/100
Desired Tone: ${tone}

Generate 3 optimized variants following the 285-point system.`;
    
    // 7. Call OpenAI API
    console.log(`[${requestId}] Calling OpenAI GPT-4o with 285-point system...`);
    const client = getOpenAIClient();
    const completion = await client.chat.completions.create({
      model: 'gpt-4o',
      messages: [
        { role: 'system', content: systemPrompt },
        { role: 'user', content: userPrompt },
      ],
      response_format: { type: 'json_object' },
      temperature: 0.4,
      max_tokens: 3000, // Increased for detailed 285-point breakdown
    });
    
    console.log(`[${requestId}] OpenAI API call successful`);
    
    const responseContent = completion.choices[0]?.message?.content;
    if (!responseContent) {
      throw new Error('No response from OpenAI');
    }
    
    // 8. Parse AI response
    const aiResponse = JSON.parse(responseContent);
    const variants: any[] = aiResponse.variants || [];
    
    if (variants.length === 0) {
      throw new Error('No variants generated');
    }
    
    // 9. Process variants (keep AI scores or calculate if missing)
    const enhancedVariants: OptimizationVariant[] = variants.map((variant, index) => {
      const variantTags = variant.tags || [];
      while (variantTags.length < 13) {
        variantTags.push(`tag${variantTags.length + 1}`);
      }
      
      const analysis = analyzeListingQuality(
        variant.title,
        variant.description,
        variantTags.slice(0, 13),
        platform
      );
      
      const advancedScores = calculateAdvancedScores(variant, analysis, platform);
      
      const copyScore = Math.round(
        advancedScores.clarity! * 0.25 +
        advancedScores.persuasion! * 0.25 +
        advancedScores.seoDensity! * 0.25 +
        advancedScores.keywordHarmony! * 0.25
      );
      
      return {
        title: variant.title,
        description: variant.description,
        tags: variantTags.slice(0, 13),
        copyScore,
        ...advancedScores,
      } as OptimizationVariant;
    });
    
    // 10. Calculate health score
    const avgCopyScore = enhancedVariants.reduce((sum, v) => sum + v.copyScore, 0) / enhancedVariants.length;
    const healthScore = Math.round(avgCopyScore);
    
    // 11. Save to database
    await prisma.$transaction(async (tx) => {
      // Create variant records
      for (let i = 0; i < enhancedVariants.length; i++) {
        const variant = enhancedVariants[i];
        await tx.optimizationVariant.create({
          data: {
            optimizationId: optimization.id,
            variantNumber: i + 1,
            title: variant.title,
            description: variant.description,
            tags: variant.tags,
            score: variant.copyScore,
            reasoning: `Copy Score: ${variant.copyScore}, CTR: ${variant.ctrProbability}%, Conversion: ${variant.conversionProbability}%`,
            metadata: {
              clarity: variant.clarity,
              persuasion: variant.persuasion,
              seoDensity: variant.seoDensity,
              keywordHarmony: variant.keywordHarmony,
              readabilityScore: variant.readabilityScore,
              emotionScore: variant.emotionScore,
              ctrProbability: variant.ctrProbability,
              conversionProbability: variant.conversionProbability,
            },
          },
        });
      }
      
      // Update optimization status
      await tx.optimization.update({
        where: { id: optimization.id },
        data: {
          status: 'completed',
          creditsUsed: 1,
          result: {
            healthScore,
            variantCount: enhancedVariants.length,
            rationale: aiResponse.rationale || aiResponse.analysis?.primaryKeyword || 'Optimizations generated',
            primaryKeyword: aiResponse.analysis?.primaryKeyword || aiResponse.primaryKeyword || '',
            analysis: aiResponse.analysis || {},
          },
          completedAt: new Date(),
        },
      });
      
      // 12. Deduct 1 credit
      await tx.creditLedger.create({
        data: {
          userId: user.id,
          amount: -1,
          balance: currentBalance - 1,
          type: 'usage',
          description: `Listing optimization - ${platform} (285-point)`,
          referenceId: optimization.id,
          referenceType: 'optimization',
          metadata: {
            optimizationId: optimization.id,
            platform,
            tone,
            variantCount: enhancedVariants.length,
            system: '285-point',
          },
        },
      });
    });
    
    console.log(`[${requestId}] Optimization complete with 285-point system`);
    
    // 13. Return enhanced response
    return NextResponse.json({
      ok: true,
      optimizationId: optimization.id,
      creditsRemaining: currentBalance - 1,
      variant_count: enhancedVariants.length,
      variants: enhancedVariants,
      healthScore,
      analysis: aiResponse.analysis || {
        primaryKeyword: aiResponse.primaryKeyword || '',
        buyerIntent: 'Not specified',
        criticalIssues: [],
        quickWins: []
      },
      metadata: {
        model: 'gpt-4o',
        platform,
        tone,
        requestId,
        scoringSystem: '285-point',
      },
    });
    
  } catch (error: any) {
    console.error(`[${requestId}] Error:`, error);
    
    // Handle errors...
    if (error instanceof z.ZodError) {
      return NextResponse.json(
        {
          ok: false,
          error: {
            code: 'validation_error',
            message: 'Invalid input parameters',
            details: error.issues,
            requestId,
          },
        },
        { status: 400 }
      );
    }
    
    return NextResponse.json(
      {
        ok: false,
        error: {
          code: 'internal_error',
          message: error.message || 'Failed to optimize listing',
          requestId,
        },
      },
      { status: 500 }
    );
  }
}

=== END OF FILE ===

[... Continue with remaining files...]
